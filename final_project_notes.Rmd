---
title: "R Notebook"
output: html_notebook
---

# Libraries

```{r}
library(tidyverse)
library(janitor)
library(infer)
```
# Datasets 

```{r}
community_belonging <- read_csv("data/community_belonging.csv") %>% clean_names()
```

```{r}
green_spaces <- read_csv("data/green_spaces.csv") %>% clean_names()
```

```{r}
neighbouhood_rating <- read_csv("data/neighbourhood_rating.csv") %>% clean_names()
```

```{r}
aggregate_dataset <- read_csv("data/shs_aggregate_responses.csv") %>% clean_names()
```



## Notes about the datasets

- There aren't any NAs
- There are, however, missing values. For example, for some councils there is no data for "other" ethnicity or for the 20% most deprived SIMD quintile. According to the data documentation: "some tables include missing values. This is where the base on which percentages would be calculated is less than 50 and this data is judged to be insufficiently robust for publication." This means that in some councils, the sample group for some groups was too small for percentages to be published.
- Both the neighbourhood rating and the community belonging datasets have links to the green spaces dataset, implying that there is perhaps an expected link between the distance participants had to walk to access a green space and how they rated their neighbourhood or how strongly they felt they belonged to their local community.
- There are local authority codes, we should join on the LA names

```{r}
la_names <- read_csv("data/council_areas_2011_2019.csv") %>% clean_names()
```



```{r}
aggregate_dataset %>% head()
```
```{r}
aggregate_dataset %>% skimr::skim()
```
# Definitions

 - Green space - A park, countryside, wood, play area, canal path, riverside or beach â€“ not including private gardens (Scottish household                    survey, 2019)
 - Urban/rural classification - This uses the 2 fold urban/rural Scottish classification, which defines a rural area as having a population                                 of fewer than 3000 people (Scottish Government Urban/Rural classification, 2020)                
 
 
 Sources:
 - Scottish government Urban/Rural classification (2020)
 https://www.gov.scot/publications/scottish-government-urban-rural-classification-2020/pages/2/
 - Scottish household survey questionnaire (2019)
 https://www.gov.scot/publications/scottish-household-survey-questionnaires/
 

# Assumptions

1) Independence of observations, meaning that if we filter out the "All" values for any of the demographic variables, there are no observations that are in two categories (e.g. the participants who were in the "white" group for ethnicity aren't also being counted in the means for "other" ethnicity group)


# Data cleaning - Green spaces
## Join with LA names

```{r}
#drop variables not needed from LA names
la_names <- la_names %>% select(ca, ca_name)

#join green spaces
green_spaces <- green_spaces %>% left_join(la_names, by = c("feature_code" = "ca")) %>% 
  mutate(ca_name = if_else(is.na(ca_name), "All Scotland", ca_name)) 
```


## Factor the variables
```{r}
green_spaces <- green_spaces %>% 
  mutate(age = factor(age, levels = c("16-34 years", "35-64 years",
                                      "65 years and over", "All")),
         simd_quintiles = factor(simd_quintiles, levels = c("20% most deprived",
                                                            "80% least deprived",
                                                            "All")),
         distance_to_nearest_green_or_blue_space = factor(
           distance_to_nearest_green_or_blue_space, levels = c(
             "A 5 minute walk or less",
             "Within a 6-10 minute walk",
             "An 11 minute walk or more",
             "Don't Know"
           )
         )) 
```


# Question 1 - exploratory visualisations

## Make function to get demographic difference graphs
```{r}
get_demographic_difference_graph <- 
  function(dataset, grouping_variable, distance_variable) {
  
  grouping_variable <- enquo(grouping_variable)
  distance_variable <- enquo(distance_variable)
  
  dataset %>% 
    filter(measurement == "Percent") %>% 
    group_by(!!grouping_variable, !!distance_variable) %>% 
    summarise(mean_percentage = mean(value)) %>% 
    ggplot(aes(x = (!!grouping_variable),
         y = mean_percentage,
         fill = (!!distance_variable)))+
    geom_col(position = "dodge")+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
}
```


## Make function to get grouped distance means

```{r}
get_grouped_distance_means <- 
  function(dataset, grouping_variable, distance_variable) {
  
  grouping_variable <- enquo(grouping_variable)
  distance_variable <- enquo(distance_variable)
  
  dataset %>% 
    filter(measurement == "Percent") %>% 
    group_by(!!grouping_variable, !!distance_variable) %>% 
    summarise(mean_percentage = mean(value))
}
```


## Differences by age **
```{r}
get_grouped_distance_means(dataset = green_spaces,
                            grouping_variable = age,
                            distance_variable = distance_to_nearest_green_or_blue_space)
```

```{r}
get_demographic_difference_graph(dataset = green_spaces,
                                 grouping_variable = age,
                                 distance_variable = distance_to_nearest_green_or_blue_space) +
  labs(title = "Age differences in access to green space",
       x = "Age",
       y = "Mean percentage",
       fill = "Distance to nearest green space")+
  scale_fill_viridis_d()
```



## Differences by sex

```{r}
get_grouped_distance_means(dataset = green_spaces,
                            grouping_variable = gender,
                            distance_variable = distance_to_nearest_green_or_blue_space)
```


```{r}
get_demographic_difference_graph(dataset = green_spaces,
                                 grouping_variable = gender,
                                 distance_variable = distance_to_nearest_green_or_blue_space)
```

## Differences in SIMD **

```{r}
get_grouped_distance_means(dataset = green_spaces,
                            grouping_variable = simd_quintiles,
                            distance_variable = distance_to_nearest_green_or_blue_space)
```


```{r}
get_demographic_difference_graph(dataset = green_spaces,
                                 grouping_variable = simd_quintiles,
                                 distance_variable = distance_to_nearest_green_or_blue_space)+
  labs(title = "SIMD differences in access to green space",
       x = "\nSIMD",
       y = "Mean percentage",
       fill = "Distance to nearest green space")+
  scale_fill_viridis_d()
```



## Differences in type of tenure

```{r}
get_grouped_distance_means(dataset = green_spaces,
                                 grouping_variable = type_of_tenure,
                                 distance_variable = distance_to_nearest_green_or_blue_space)
```


```{r}
get_demographic_difference_graph(dataset = green_spaces,
                                 grouping_variable = type_of_tenure,
                                 distance_variable = distance_to_nearest_green_or_blue_space)
```

## Differences by household type **

```{r}
get_demographic_difference_graph(dataset = green_spaces,
                                 grouping_variable = household_type,
                                 distance_variable = distance_to_nearest_green_or_blue_space)+
    labs(title = "Household type differences in access to green space",
       x = "Household type",
       y = "Mean percentage",
       fill = "Distance to nearest green space")+
  scale_fill_viridis_d()
```

## Differences by ethnicity **

```{r}
get_grouped_distance_means(dataset = green_spaces,
                                 grouping_variable = ethnicity,
                                 distance_variable = distance_to_nearest_green_or_blue_space)
```


```{r}
get_demographic_difference_graph(dataset = green_spaces,
                                 grouping_variable = ethnicity,
                                 distance_variable = distance_to_nearest_green_or_blue_space)+
  labs(title = "Ethnicity differences in access to green space",
       x = "\nEthnicity",
       y = "Mean percentage",
       fill = "Distance to nearest green space")+
  scale_fill_viridis_d()
```

## Differences by urban/rural **

```{r}
get_demographic_difference_graph(dataset = green_spaces,
                                 grouping_variable = urban_rural_classification,
                                 distance_variable = distance_to_nearest_green_or_blue_space)
```
## Differences by local authority

```{r}
get_grouped_distance_means(dataset = green_spaces,
                                 grouping_variable = ca_name,
                                 distance_variable = distance_to_nearest_green_or_blue_space) 
```


```{r}
get_demographic_difference_graph(dataset = green_spaces,
                                 grouping_variable = ca_name,
                                 distance_variable = distance_to_nearest_green_or_blue_space)
```
### Notes

There's a lot of data here, so let's look closer at two councils that are different from each other and do a mini case study. I've chosen these two councils because they have the highest and lowest average percentages of people who can access a green space within 5 minutes of their residence and contain both urban and rural areas.

- East Lothian
    - Over 80% of people on average can access a green space within a 5 minute walk
- South Lanarkshire
    - Just over 60% of people on average can access a green space within a 5 minute walk

# Question 1 Statistical tests for differences in access
## SIMD **

The test was significant at the 99.99% level (p < 0.01). We can say that the mean percentage of people in the 80% least deprived SIMD quintiles who are able to access a green space within 5 minutes is significantly different from the mean percentage of people in the 20% most deprived SIMD quintile who are able to access a green space within 5 minutes. Specifically, significantly more people in the 80% least deprived SIMD quintiles are able to access a green space within 5 minutes of where they live.

### Hypothesis
H0 - There is no difference between the mean percentage of people able to access a green space within a 5 minutes walk by SIMD level (20% most deprived SIMD and 80% least deprived)
H1 - There is a significant difference between the mean percentage of people able to access a green space within a 5 minute walk by SIMD level (20% most deprived SIMD and 80% least deprived)

### Box plots
```{r}
#Look at the differences on the boxplot by SIMD
green_spaces %>% 
  filter(simd_quintiles != "All" & #remove amalgamated values
           measurement == "Percent" & #filter out confidence interval values
           distance_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>% #specify 5 min walk as the value of interest
  ggplot(aes(x = simd_quintiles,
             y = value
             ))+
  geom_boxplot(aes(fill = simd_quintiles), show.legend = FALSE)+
  geom_jitter(alpha = 0.3)+
  labs(title = "SIMD differences in access to greenspace within 5 minutes",
       x = "SIMD",
       y = "Mean percentage")+
  scale_fill_viridis_d()
```
### Two sample difference in means test
```{r}
#generate the null distribution
null_distribution <- green_spaces %>% 
  filter(simd_quintiles != "All" & #remove amalgamated values
           measurement == "Percent" & #filter out confidence interval values
           distance_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>% #specify 5 min walk as the value of interest 
  specify(value ~ simd_quintiles) %>% 
  hypothesise(null = "independence") %>% 
  generate(reps = 5000, type = "permute") %>% 
  calculate(stat = "diff in means", order = c("80% least deprived", "20% most deprived"))
```
```{r}
#calculate the observed stat
observed_stat <- green_spaces %>% 
  filter(simd_quintiles != "All" & #remove amalgamated values
           measurement == "Percent" & #filter out confidence interval values
           distance_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>% #specify 5 min walk as the value of interest 
  specify(value ~ simd_quintiles) %>%
  calculate(stat = "diff in means", order = c("80% least deprived", "20% most deprived"))
```

```{r}
#visualise the observed stat on the null distribution
null_distribution %>% 
  visualise()+
  shade_p_value(obs_stat = observed_stat, direction = "both")#interested in any significant difference
```

```{r}
#get p value
null_distribution %>% 
  get_p_value(obs_stat = observed_stat, direction = "both")
```

## Ethnicity **

The test was significant at the 99.99% level (p < 0.01), meaning that we can reject the null hypothesis that there is no difference between the mean percentage of people who can access a green space within 5 minutes walk from their house by ethnicity. The test shows that significantly more white people can access a green space within 5 minutes walk from their residence. There is a clear racial disparity in access to green spaces.

Note: there are very few observations of "Other" ethnicity (18). We're using bootstrapping, so this is probably okay for the statistical test but it's worth noting that the groups are very unequal and the "Other" ethnicity observations are only in Glasgow, Edinburgh and an amalgamated value for All Scotland.

### Hypothesis

H0 - There is no difference between the mean percentage of people able to access a green space within a 5 minutes walk by ethnicity 
H1 - There is a significant difference between the mean percentage of people able to access a green space within a 5 minute walk by ethnicity


### Box plots
```{r}
#Look at the differences on the boxplot by ethnicity
green_spaces %>% 
  filter(ethnicity != "All" & #remove amalgamated values
           measurement == "Percent" & #filter out confidence interval values
           distance_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>% #specify 5 min walk as the value of interest
  ggplot(aes(x = ethnicity,
             y = value))+
  geom_boxplot(aes(fill = ethnicity), show.legend = FALSE)+
  geom_jitter(alpha = 0.3)+
  labs(title = "Ethnicity differences in access to greenspace within 5 minutes",
       x = "Ethnicity",
       y = "Mean percentage")+
  scale_fill_viridis_d()
```
### Two sample difference in means test
```{r}
#generate the null distribution
null_distribution <- green_spaces %>% 
  filter(ethnicity != "All" & #remove amalgamated values
           measurement == "Percent" & #filter out confidence interval values
           distance_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>% #specify 5 min walk as the value of interest 
  specify(value ~ ethnicity) %>% 
  hypothesise(null = "independence") %>% 
  generate(reps = 5000, type = "permute") %>% 
  calculate(stat = "diff in means", order = c("White", "Other"))
```

```{r}
observed_stat <- green_spaces %>% 
  filter(ethnicity != "All" & #remove amalgamated values
           measurement == "Percent" & #filter out confidence interval values
           distance_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>% #specify 5 min walk as the value of interest 
  specify(value ~ ethnicity) %>% 
  calculate(stat = "diff in means", order = c("White", "Other"))
```

```{r}
null_distribution %>% 
  visualise()+
  shade_pvalue(obs_stat = observed_stat, direction = "both")
```

```{r}
null_distribution %>% 
  get_p_value(obs_stat = observed_stat, direction = "both")
```

## Age **

Significant at the 99.99% confidence level (p < 0.01) for the difference between the age group over 65 and the 16-34 and 35-64 age groups. In this case, there is sufficient evidence to reject the null hypothesis that there is no difference between these groups in terms of the mean percentage of people who are able to access a green space within a 5 min walk. Specifically, the mean percentage of people over 65 who are able to access a green space within 5 min is significantly less than the other two groups.

### Hypothesis
H0 - There is no difference between the mean percentage of people able to access a green space within a 5 minutes walk by age group 
H1 - There is a significant difference between the mean percentage of people able to access a green space within a 5 minute walk by age group


### Libraries
```{r}
library(car)
library(dlookr)
library(ggstatsplot)
```
```{r}
subset_age_5min_access <- green_spaces %>% 
  filter(age != "All" & #remove amalgamated values
           measurement == "Percent" & #filter out confidence interval values
           distance_to_nearest_green_or_blue_space == "A 5 minute walk or less") #specify 5 min walk as the value of interest
```

### Normality and homogeneity of variance tests
```{r}
#test for homogeneity of variance
leveneTest(subset_age_5min_access$value, subset_age_5min_access$age, center = mean)
```
Levene's test is significant, so we can't assume homogeneity of variance. Side note that this could be because of the because of the fairly large amount of data that we have, which could mean that even small differences could become significant. Nevertheless, we should test for normality to see if we can use Welch's F instead, which doesn't assume homegeneity of variance (Field, 2012, p 441).


We can use the dlookr package to test for normal distributions within specific groups (see https://yuzar-blog.netlify.app/posts/2022-04-03-anova/) 
```{r}
#This uses the shapiro-wilk test to test for normal distribution within groups
subset_age_5min_access %>% 
  group_by(age) %>% 
  normality(value)
```
Some of the p-values are significant at the 95% confidence level, so we shouldn't use ANOVA here. However, we can use the Kruskal-Wallis test using the ggstatsplot package.

### Kruskal-Wallis test
```{r}
ggbetweenstats(
  data = subset_age_5min_access,
  x = age,
  y = value,
  type = "nonparametric"
)

```
We can see that the difference between the mean value of people 65+ who can access a green space within a 5 minute walk is significantly different from both the 16-34 y/o group and the 35-64 y/o group.


## Household type **

Significant at the 99.99% confidence level (p < 0.01) for the difference between pensioners and adult households/households with children. In this case, there is sufficient evidence to reject the null hypothesis that there is no difference between these groups in terms of the mean percentage of people who are able to access a green space within a 5 min walk. Specifically, the mean percentage of pensioners who are able to access a green space within 5 min is significantly less than the other two groups.

### Hypothesis
H0 - There is no difference between the mean percentage of people able to access a green space within a 5 minutes walk by household type 
H1 - There is a significant difference between the mean percentage of people able to access a green space within a 5 minute walk by household type

```{r}
#create subset of data
subset_hh_type_5min_access <- green_spaces %>% 
  filter(household_type != "All" & #remove amalgamated values
           measurement == "Percent" & #filter out confidence interval values
           distance_to_nearest_green_or_blue_space == "A 5 minute walk or less") #specify 5 min walk as the value of interest
```

### Normality and homogeneity of variance tests

```{r}
#test for homogeneity of variance in the values for different household types w/ Levene Test
leveneTest(subset_hh_type_5min_access$value, 
           subset_hh_type_5min_access$household_type,
           center = mean)
```

```{r}
#This uses the shapiro-wilk test to test for normal distribution within groups
subset_hh_type_5min_access %>% 
  group_by(household_type) %>% 
  normality(value)
```
Homogeneity of variance can't be assumed, but the data is normally distributed, so we can use Welch's F in an ANOVA test (Field, 2012, p 441). 

### ANOVA

```{r}
ggbetweenstats(
  data = subset_hh_type_5min_access,
  x = household_type,
  y = value,
  type = "parametric",
  var.equal = FALSE
)
```

This aligns with the age results where people over 65 had less access to green spaces and can be grouped together with this finding in the presentation.

## Urban/rural classification **

Significant at the 99.99% confidence level (p < 0.01). We can say that the mean percentage of people in rural areas who are able to access a green space within 5 minutes is significantly different from the mean percentage of people in urban areas who are able to access a green space within 5 minutes. Specifically, significantly more people living in rural areas are able to access a green space within 5 minutes of where they live. On average, 12.5% more people in rural areas (mean = 77.8%) are able to access a green space within 5 minutes of walking than people in urban areas (mean = 65.3%)

### Hypothesis
H0 - There is no difference between the mean percentage of people able to access a green space within a 5 minutes walk by urban/rural classification
H1 - There is a significant difference between the mean percentage of people able to access a green space within a 5 minute walk by urban/rural classification

### Box plots
```{r}
#Look at the differences on the boxplot by urban/rural classification
green_spaces %>% 
  filter(urban_rural_classification != "All" & #remove amalgamated values
           measurement == "Percent" & #filter out confidence interval values
           distance_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>% #specify 5 min walk as the value of interest
  ggplot(aes(x = urban_rural_classification,
             y = value))+
  geom_boxplot()+
  geom_jitter(alpha = 0.3)
```

From these box-plots, I think we can expect to see significant differences in the independent samples test. I also noticed that there are fewer observations for Rural than Urban, so I was interested in seeing which councils had no rural areas.

### Councils with no rural areas
```{r}
#get list of councils with rural areas
councils_with_rural_areas <- green_spaces %>% 
  filter(urban_rural_classification == "Rural" & #remove amalgamated values
           measurement == "Percent"# & #filter out confidence interval values
           #distance_to_nearest_green_or_blue_space == "A 5 minute walk or less"
         ) %>% 
  distinct(ca_name) %>% 
  arrange(ca_name) %>% 
  pull()

#filter to find councils with no rural areas
green_spaces %>% 
  select(ca_name) %>% 
  filter(!ca_name %in% councils_with_rural_areas) %>% 
  distinct(ca_name) %>% 
  arrange(ca_name)
```
### Two sample difference in means test

```{r}
#generate the null distribution
null_distribution <- green_spaces %>% 
  filter(urban_rural_classification != "All" & #remove amalgamated values
           measurement == "Percent" & #filter out confidence interval values
           distance_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>% #specify 5 min walk as the value of interest 
  specify(value ~ urban_rural_classification) %>% 
  hypothesise(null = "independence") %>% 
  generate(reps = 5000, type = "permute") %>% 
  calculate(stat = "diff in means", order = c("Rural", "Urban"))
```

```{r}
observed_stat <- green_spaces %>% 
  filter(urban_rural_classification != "All" & #remove amalgamated values
           measurement == "Percent" & #filter out confidence interval values
           distance_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>% #specify 5 min walk as the value of interest 
  specify(value ~ urban_rural_classification) %>% 
  calculate(stat = "diff in means", order = c("Rural", "Urban"))
```

```{r}
null_distribution %>% 
  visualise()+
  shade_pvalue(obs_stat = observed_stat, direction = "both")
```


```{r}
null_distribution %>% 
  get_p_value(obs_stat = observed_stat, direction = "both")
```

```{r}
observed_stat
```
```{r}
get_grouped_distance_means(dataset = green_spaces,
                           grouping_variable = urban_rural_classification,
                           distance_variable = distance_to_nearest_green_or_blue_space) %>% 
  filter(urban_rural_classification != "All")
```

# Question 1 - Geographical comparison mini case study

I've chosen three councils for the case study. I've chosen East Lothian and South Lanarkshire because they have the highest and lowest average percentages of people who can access a green space within 5 minutes of their residence and contain both urban and rural areas, making them interesting cases for comparison. I've also added on West Dunbartonshire because it has the lowest percentage of people who can access a green space within 5 minutes of their residence.

- East Lothian
    - Over 80% of people on average can access a green space within a 5 minute walk
- South Lanarkshire
    - Just over 60% of people on average can access a green space within a 5 minute walk



## Demographic comparison
```{r}
green_spaces %>% 
  filter(ca_name %in% c("South Lanarkshire", "East Lothian") &
           measurement == "Percent" &
           urban_rural_classification != "All" &
           distance_to_nearest_green_or_blue_space != "Don't Know") %>% 
  group_by(ca_name, urban_rural_classification, distance_to_nearest_green_or_blue_space) %>% 
  summarise(mean_percentage = mean(value)) %>% 
  ggplot(aes(x = urban_rural_classification,
         y = mean_percentage,
         fill = ca_name)) +
  geom_col(position = "dodge")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  facet_wrap(~distance_to_nearest_green_or_blue_space)
  
```

```{r}
green_spaces %>% 
  filter(ca_name %in% c("West Dunbartonshire", "East Lothian") &
           distance_to_nearest_green_or_blue_space != "Don't Know" &
           measurement == "Percent") %>% 
  group_by(ca_name, date_code, distance_to_nearest_green_or_blue_space) %>% 
  summarise(mean_percentage = mean(value)) %>% 
  ggplot(aes(x = factor(date_code),
             y = mean_percentage,
             colour = distance_to_nearest_green_or_blue_space)) +
  geom_point()+
  geom_line(aes(x = factor(date_code),
                y = mean_percentage,
                group = distance_to_nearest_green_or_blue_space))+
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  facet_wrap(~ca_name)
```






# Question 2 - Trends over time


```{r}
green_spaces %>% 
  filter(ca_name == "All Scotland" &
           distance_to_nearest_green_or_blue_space != "Don't Know" &
           measurement == "Percent" ) %>% 
  group_by(date_code, distance_to_nearest_green_or_blue_space) %>% 
  summarise(mean_percentage = mean(value)) %>% 
  ggplot(aes(x = factor(date_code),
             y = mean_percentage,
             colour = distance_to_nearest_green_or_blue_space)) +
  geom_point()+
  geom_line(aes(x = factor(date_code),
                y = mean_percentage,
                group = distance_to_nearest_green_or_blue_space))+
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```


## Urban rural access over time
```{r}
green_spaces %>% 
  filter(ca_name == "All Scotland" &
           distance_to_nearest_green_or_blue_space != "Don't Know" &
           measurement == "Percent" &
           urban_rural_classification != "All") %>% 
  group_by(date_code, urban_rural_classification, distance_to_nearest_green_or_blue_space) %>% 
  summarise(mean_percentage = mean(value)) %>% 
  ggplot(aes(x = factor(date_code),
             y = mean_percentage,
             colour = distance_to_nearest_green_or_blue_space)) +
  geom_point()+
  geom_line(aes(x = factor(date_code),
                y = mean_percentage,
                group = distance_to_nearest_green_or_blue_space))+
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  facet_wrap(~urban_rural_classification)
```
## SIMD access over time

```{r}
green_spaces %>% 
  filter(ca_name == "All Scotland" &
           distance_to_nearest_green_or_blue_space != "Don't Know" &
           measurement == "Percent" &
           simd_quintiles != "All") %>% 
  group_by(date_code, simd_quintiles, distance_to_nearest_green_or_blue_space) %>% 
  summarise(mean_percentage = mean(value)) %>% 
  ggplot(aes(x = factor(date_code),
             y = mean_percentage,
             colour = distance_to_nearest_green_or_blue_space)) +
  geom_point()+
  geom_line(aes(x = factor(date_code),
                y = mean_percentage,
                group = distance_to_nearest_green_or_blue_space))+
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  facet_wrap(~simd_quintiles)
```
## Ethnicity access over time

```{r}
green_spaces %>% 
  filter(ca_name == "All Scotland" &
           distance_to_nearest_green_or_blue_space != "Don't Know" &
           measurement == "Percent" &
           ethnicity != "All") %>% 
  group_by(date_code, ethnicity, distance_to_nearest_green_or_blue_space) %>% 
  summarise(mean_percentage = mean(value)) %>% 
  ggplot(aes(x = factor(date_code),
             y = mean_percentage,
             colour = distance_to_nearest_green_or_blue_space)) +
  geom_point()+
  geom_line(aes(x = factor(date_code),
                y = mean_percentage,
                group = distance_to_nearest_green_or_blue_space))+
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  facet_wrap(~ethnicity)
```
## Age access over time
```{r}
green_spaces %>% 
  filter(ca_name == "All Scotland" &
           distance_to_nearest_green_or_blue_space != "Don't Know" &
           measurement == "Percent" &
           age != "All") %>% 
  group_by(date_code, age, distance_to_nearest_green_or_blue_space) %>% 
  summarise(mean_percentage = mean(value)) %>% 
  ggplot(aes(x = factor(date_code),
             y = mean_percentage,
             colour = distance_to_nearest_green_or_blue_space)) +
  geom_point()+
  geom_line(aes(x = factor(date_code),
                y = mean_percentage,
                group = distance_to_nearest_green_or_blue_space))+
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  facet_wrap(~age)
```
## Household type access over time

```{r}
green_spaces %>% 
  filter(ca_name == "All Scotland" &
           distance_to_nearest_green_or_blue_space != "Don't Know" &
           measurement == "Percent" &
           household_type != "All") %>% 
  group_by(date_code, household_type, distance_to_nearest_green_or_blue_space) %>% 
  summarise(mean_percentage = mean(value)) %>% 
  ggplot(aes(x = factor(date_code),
             y = mean_percentage,
             colour = distance_to_nearest_green_or_blue_space)) +
  geom_point()+
  geom_line(aes(x = factor(date_code),
                y = mean_percentage,
                group = distance_to_nearest_green_or_blue_space))+
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  facet_wrap(~household_type)
```
## LA comparison over time

```{r}
green_spaces %>% 
  filter(ca_name %in% c("West Dunbartonshire", "East Lothian") &
           distance_to_nearest_green_or_blue_space != "Don't Know" &
           measurement == "Percent") %>% 
  group_by(ca_name, date_code, distance_to_nearest_green_or_blue_space) %>% 
  summarise(mean_percentage = mean(value)) %>% 
  ggplot(aes(x = factor(date_code),
             y = mean_percentage,
             colour = distance_to_nearest_green_or_blue_space)) +
  geom_point()+
  geom_line(aes(x = factor(date_code),
                y = mean_percentage,
                group = distance_to_nearest_green_or_blue_space))+
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  facet_wrap(~ca_name)
```

# Question 3 - Differences in neighbourhood ratings


## Cleaning/wrangling
```{r}
#join la names
neighbouhood_rating <- neighbouhood_rating %>% left_join(la_names, by = c("feature_code" = "ca")) %>% 
  mutate(ca_name = if_else(is.na(ca_name), "All Scotland", ca_name)) 
```

```{r}
neighbouhood_rating <- neighbouhood_rating %>% 
  mutate(simd_quintiles = factor(simd_quintiles, levels = c("20% most deprived",
                                                            "80% least deprived",
                                                            "All")),
         walking_distance_to_nearest_greenspace = factor(
           walking_distance_to_nearest_greenspace, levels = c(
             "Less than 10 minutes",
             "More than 10 minutes",
             "Don't Know",
             "All")
         ),
         neighbourhood_rating = factor(neighbourhood_rating, levels = c(
           "Very good",
           "Fairly good",
           "Fairly poor",
           "Very poor",
           "No opinion"
         ))) 
```

## Transform dataset

We want to compare the mean percentages of people who rated their neighbourhood as good or very good based on their access to green space. Therefore, we need to transform the dataset so that there are only two levels for neighbourhood rating and the mean percentages can be compared using a two sample difference in means test.

Since the values are already percentages, you need to sum the values in the two "Good" levels and the values in the two "Poor" levels, so this is the approach that I'm taking here.

```{r}
#Transform to binary neighbourhood ratings to compare mean percentages
comb_neighbourhood_rating <- neighbouhood_rating %>% 
  select(-c(feature_code, units, gender, urban_rural_classification, simd_quintiles,
            type_of_tenure, household_type, ethnicity)) %>% 
  filter(!walking_distance_to_nearest_greenspace %in% c("Don't Know", "All") &
           neighbourhood_rating != "No opinion" &
           measurement == "Percent") %>% #remove confidence interval values to get mean of percentages only
  group_by(ca_name, date_code, walking_distance_to_nearest_greenspace, neighbourhood_rating) %>% 
  summarise(mean_percentage = mean(value)) %>% #get mean percentages for grouped data
  mutate(neighbourhood_binary = if_else(
    neighbourhood_rating %in% c("Fairly good", "Very good"), "Good", "Poor")) %>% #transform to 2 levels
  select(-neighbourhood_rating) %>% #take out original neighbourhood ratings
  group_by(ca_name, date_code, walking_distance_to_nearest_greenspace, neighbourhood_binary) %>% #regroup by binary neighbourhood rating
  summarise(mean_percentage = sum(mean_percentage))#sum mean percentages for new good and poor levels
```
## Hypothesis test - "Good" neighbourhood rating and access to green space

The test was significant at the 99.99% level (p < 0.01). This means that we can reject the null hypothesis that there is no significant difference in the mean percentages of people rating their neighbourhood as "Good" between the group of people who can access a green space within a 10 minute walk and the group of people who have to walk over 10 minutes to access a green space. Specifically, on average, more people who had to walk less than 10 min to access a green space rated their neighbourhoods as "good" (95.5%) than people who had to walk further to access a green space (92.85%). 

```{r}
comb_neighbourhood_rating %>% 
  filter(neighbourhood_binary == "Good") %>% 
  group_by(walking_distance_to_nearest_greenspace) %>% 
  summarise(mean_percentage = mean(mean_percentage))
```


### Hypothesis

H0 - There is no significant difference in the mean percentages of people assigning "good" ratings based on their access to a green space. 

H1 - There is a significant difference in the mean percentages of people assigning "good" ratings based on their access to a green space. 

### Box plots

```{r}
comb_neighbourhood_rating %>% 
filter(neighbourhood_binary == "Good") %>% 
  ggplot(aes(x = walking_distance_to_nearest_greenspace,
             y = mean_percentage))+
  geom_boxplot(aes(fill = walking_distance_to_nearest_greenspace), show.legend = FALSE) +
  geom_jitter()+
  labs(title = "Relationship between good neighbourhood ratings and access to green spaces",
       x = "\nWalking distance to nearest green space",
       y = "Mean percentage of 'good' ratings")+
  scale_fill_viridis_d()
```





### Two sample difference in means test - Good ratings


```{r}
#generate the null distribution
null_distribution <- comb_neighbourhood_rating %>% 
filter(neighbourhood_binary == "Good") %>% #specify "Good" ratings as the value of interest 
  specify(mean_percentage ~ walking_distance_to_nearest_greenspace) %>% 
  hypothesise(null = "independence") %>% 
  generate(reps = 5000, type = "permute") %>% 
  calculate(stat = "diff in means", order = c("Less than 10 minutes", 
                                              "More than 10 minutes"))
```

```{r}
observed_stat <- comb_neighbourhood_rating %>% 
filter(neighbourhood_binary == "Good") %>% #specify "Good" ratings as the value of interest 
  specify(mean_percentage ~ walking_distance_to_nearest_greenspace) %>% 
  calculate(stat = "diff in means", order = c("Less than 10 minutes", 
                                              "More than 10 minutes"))
```

```{r}
null_distribution %>% 
  visualise()+
  shade_pvalue(obs_stat = observed_stat, direction = "both")
```
```{r}
null_distribution %>% 
  get_p_value(obs_stat = observed_stat, direction = "both")
```


## Hypothesis test - "Poor" neighbourhood rating and access to green space

The test was significant at the 99.99% level (p < 0.01). This means that we can reject the null hypothesis that there is no significant difference in the mean percentages of people rating their neighbourhood as "Poor" between the group of people who can access a green space within a 10 minute walk and the group of people who have to walk over 10 minutes to access a green space. Specifically, on average, fewer people who had to walk less than 10 min to access a green space rated their neighbourhoods as "poor" (4.26%) than people who had to walk further to access a green space (7.27%). 

```{r}
comb_neighbourhood_rating %>% 
  filter(neighbourhood_binary == "Poor") %>% 
  group_by(walking_distance_to_nearest_greenspace) %>% 
  summarise(mean_percentage = mean(mean_percentage))
```

### Hypothesis

H0 - There is no significant difference in the mean percentages of people assigning "poor" ratings based on their access to a green space. 

H1 - There is a significant difference in the mean percentages of people assigning "poor" ratings based on their access to a green space. 

### Box plot


```{r}
comb_neighbourhood_rating %>% 
filter(neighbourhood_binary == "Poor") %>% 
  ggplot(aes(x = walking_distance_to_nearest_greenspace,
             y = mean_percentage))+
  geom_boxplot() +
  geom_jitter() 
```



### Two sample difference in means test - poor ratings


```{r}
#generate the null distribution
null_distribution <- comb_neighbourhood_rating %>% 
filter(neighbourhood_binary == "Poor") %>% #specify "Poor" ratings as the value of interest 
  specify(mean_percentage ~ walking_distance_to_nearest_greenspace) %>% 
  hypothesise(null = "independence") %>% 
  generate(reps = 5000, type = "permute") %>% 
  calculate(stat = "diff in means", order = c("Less than 10 minutes", 
                                              "More than 10 minutes"))
```

```{r}
observed_stat <- comb_neighbourhood_rating %>% 
filter(neighbourhood_binary == "Poor") %>% #specify "Poor" ratings as the value of interest 
  specify(mean_percentage ~ walking_distance_to_nearest_greenspace) %>% 
  calculate(stat = "diff in means", order = c("Less than 10 minutes", 
                                              "More than 10 minutes"))
```

```{r}
null_distribution %>% 
  visualise()+
  shade_pvalue(obs_stat = observed_stat, direction = "both")
```


```{r}
null_distribution %>% 
  get_p_value(obs_stat = observed_stat, direction = "both")
```



### LA comparison - Good and poor access to green space 

```{r}
comb_neighbourhood_rating %>% 
  filter(ca_name %in% c("West Dunbartonshire", "East Lothian")) %>% 
  group_by(ca_name, neighbourhood_binary) %>% 
  summarise(mean_percentage = mean(mean_percentage))
```


# Question 3 - Differences in community belonging



## Cleaning/wrangling
```{r}
#join la names
community_belonging <- community_belonging %>% left_join(la_names, by = c("feature_code" = "ca")) %>% 
  mutate(ca_name = if_else(is.na(ca_name), "All Scotland", ca_name)) 
```

```{r}
community_belonging <- community_belonging %>% 
  mutate(simd_quintiles = factor(simd_quintiles, levels = c("20% most deprived",
                                                            "80% least deprived",
                                                            "All")),
         walking_distance_to_nearest_greenspace = factor(
           walking_distance_to_nearest_greenspace, levels = c(
             "Less than 10 minutes",
             "More than 10 minutes",
             "Don't Know",
             "All")
         ),
         community_belonging = factor(community_belonging, levels = c(
           "Very strongly",
           "Fairly strongly",
           "Not very strongly",
           "Not at all strongly",
           "Don't know"
         ))) 
```



## Transform dataset

Just like the neighbourhood rating analysis, we want to compare the mean percentages of people who rated their feeling of belonging in their community as very strong/fairly strong vs not very strong/not at all strong based on their access to green space. Therefore, we need to transform the dataset so that there are only two levels for neighbourhood rating and the mean percentages can be compared using a two sample difference in means test.

Since the values are already percentages, you need to sum the values in the two "Strong" levels and the values in the two "Not strong" levels, so this is the approach that I'm taking here.

```{r}
#Transform to binary belonging ratings to compare mean percentages
comb_belonging <- community_belonging %>% 
  select(-c(feature_code, units, gender, urban_rural_classification, simd_quintiles,
            type_of_tenure, household_type, ethnicity)) %>% 
  filter(!walking_distance_to_nearest_greenspace %in% c("Don't Know", "All") &
           community_belonging != "Don't know" &
           measurement == "Percent") %>% #remove confidence interval values to get mean of percentages only
  group_by(ca_name, date_code, walking_distance_to_nearest_greenspace, community_belonging) %>% 
  summarise(mean_percentage = mean(value)) %>% #get mean percentages for grouped data
  mutate(belonging_binary = if_else(
    community_belonging %in% c("Fairly strongly", "Very strongly"), "Strong", "Not strong")) %>% #transform to 2 levels
  select(-community_belonging) %>% #take out original belonging ratings
  group_by(ca_name, date_code, walking_distance_to_nearest_greenspace, belonging_binary) %>% #regroup by binary belonging rating
  summarise(mean_percentage = sum(mean_percentage))#sum mean percentages for new belonging levels
```

## Hypothesis test - "Strong" belonging and access to green space

The test was significant at the 99.99% level (p < 0.01). This means that we can reject the null hypothesis that there is no significant difference in the mean percentages of people who rated their feeling of belonging in their community as "strong" between the group of people who can access a green space within a 10 minute walk and the group of people who have to walk over 10 minutes to access a green space. Specifically, on average, more people who had to walk less than 10 min to access a green space rated their feeling of belonging as "strong" (80.14%) than people who had to walk further to access a green space (74.63%). 

```{r}
comb_belonging %>% 
  filter(belonging_binary == "Strong") %>% 
  group_by(walking_distance_to_nearest_greenspace) %>% 
  summarise(mean_percentage = mean(mean_percentage))
```


### Hypothesis

H0 - There is no significant difference in the mean percentages of people assigning "strong" feelings of belonging ratings based on their access to a green space. 

H1 - There is a significant difference in the mean percentages of people assigning "strong" feelings of belonging ratings based on their access to a green space. 

### Box plots

```{r}
comb_belonging %>% 
filter(belonging_binary == "Strong") %>% 
  ggplot(aes(x = walking_distance_to_nearest_greenspace,
             y = mean_percentage))+
  geom_boxplot(aes(fill = walking_distance_to_nearest_greenspace), show.legend = FALSE) +
  geom_jitter()+
  labs(title = "Relationship between strong community belonging and access to green spaces",
       x = "\nWalking distance to nearest green space",
       y = "Mean percentage of 'strong' ratings")+
  scale_fill_viridis_d()
```

### Two sample difference in means test - Strong belonging ratings


```{r}
#generate the null distribution
null_distribution <- comb_belonging %>% 
filter(belonging_binary == "Strong") %>% #specify "Good" ratings as the value of interest 
  specify(mean_percentage ~ walking_distance_to_nearest_greenspace) %>% 
  hypothesise(null = "independence") %>% 
  generate(reps = 5000, type = "permute") %>% 
  calculate(stat = "diff in means", order = c("Less than 10 minutes", 
                                              "More than 10 minutes"))
```

```{r}
observed_stat <- comb_belonging %>% 
filter(belonging_binary == "Strong") %>% #specify "Good" ratings as the value of interest 
  specify(mean_percentage ~ walking_distance_to_nearest_greenspace) %>% 
  calculate(stat = "diff in means", order = c("Less than 10 minutes", 
                                              "More than 10 minutes"))
```

```{r}
null_distribution %>% 
  visualise()+
  shade_pvalue(obs_stat = observed_stat, direction = "both")
```
```{r}
null_distribution %>% 
  get_p_value(obs_stat = observed_stat, direction = "both")
```



## Hypothesis test - "Not strong" belonging and access to green space

The test was significant at the 99.99% level (p < 0.01). This means that we can reject the null hypothesis that there is no significant difference in the mean percentages of people who rated their feeling of belonging in their community as "not strong" between the group of people who can access a green space within a 10 minute walk and the group of people who have to walk over 10 minutes to access a green space. Specifically, on average, fewer people who had to walk less than 10 min to access a green space rated their feeling of belonging as "not strong" (19.19%) than people who had to walk further to access a green space (24.21%). 

```{r}
comb_belonging %>% 
  filter(belonging_binary == "Not strong") %>% 
  group_by(walking_distance_to_nearest_greenspace) %>% 
  summarise(mean_percentage = mean(mean_percentage))
```


### Hypothesis

H0 - There is no significant difference in the mean percentages of people assigning "not strong" feelings of belonging ratings based on their access to a green space. 

H1 - There is a significant difference in the mean percentages of people assigning "not strong" feelings of belonging ratings based on their access to a green space. 

### Box plots

```{r}
comb_belonging %>% 
filter(belonging_binary == "Not strong") %>% 
  ggplot(aes(x = walking_distance_to_nearest_greenspace,
             y = mean_percentage))+
  geom_boxplot() +
  geom_jitter()
```

### Two sample difference in means test - Not strong belonging ratings


```{r}
#generate the null distribution
null_distribution <- comb_belonging %>% 
filter(belonging_binary == "Not strong") %>% #specify "Not strong" ratings as the value of interest 
  specify(mean_percentage ~ walking_distance_to_nearest_greenspace) %>% 
  hypothesise(null = "independence") %>% 
  generate(reps = 5000, type = "permute") %>% 
  calculate(stat = "diff in means", order = c("Less than 10 minutes", 
                                              "More than 10 minutes"))
```

```{r}
observed_stat <- comb_belonging %>% 
filter(belonging_binary == "Not strong") %>% #specify "Not strong" ratings as the value of interest 
  specify(mean_percentage ~ walking_distance_to_nearest_greenspace) %>% 
  calculate(stat = "diff in means", order = c("Less than 10 minutes", 
                                              "More than 10 minutes"))
```

```{r}
null_distribution %>% 
  visualise()+
  shade_pvalue(obs_stat = observed_stat, direction = "both")
```

```{r}
null_distribution %>% 
  get_p_value(obs_stat = observed_stat, direction = "both")
```

### LA comparison - Good and poor access to green space 

```{r}
comb_belonging %>% 
  filter(ca_name %in% c("West Dunbartonshire", "East Lothian")) %>% 
  group_by(ca_name, belonging_binary) %>% 
  summarise(mean_percentage = mean(mean_percentage))
```















